{% include "@osc-unzer/frontend/tpl/order/unzer_assets.html.twig" %}
{% if oView.getPaymentSaveSetting() %}
    <div class="savedpayment">
        <form id="payment-saved-cards" class="unzerUI form" novalidate>
            {% for type, setting in unzerPaymentType %}
            {% if type == 'paypal' %}

            <table class="table">
                <thead>
                <tr>
                    <th scope="col">{{ translate({ ident: "EMAIL" }) }}</th>
                    <th scope="col">{{ translate({ ident: "OSCUNZER_BRAND" }) }}</th>
                    <th scope="col"></th>
                </tr>
                </thead>
                <tbody>
                {% set counter = 0 %}

                {% for paymenttypeid, paymentType in setting %}
                    <tr>
                        <th scope="row">{{ paymentType.email }}</th>
                        <td>{{ type }}</td>
                        <td>
                            <input type="radio" class="paymenttypeid" name="paymenttypeid" value="{{ paymenttypeid }}" style="-webkit-appearance: radio">
                        </td>
                    </tr>
                    {% endfor %}


                </tbody>
            </table>


            {% endif %}
            {% endfor %}
            {% if oView.getPaymentSaveSetting() %}
            <div id="payment-sepa-confirm">
                <div class="oscunzersavepayment" id="oscunzersavepayment_unzer">
                    <input id="oscunzersavepayment" type="checkbox" name="oscunzersavepayment" value="0" style="-webkit-appearance: checkbox">
                    <label for="oscunzersavepayment">
                        {{ translate({ ident: "OSCUNZER_SAVE_PAYPAL" }) }}
                    </label>
                </div>
            </div>
            {% endif %}
        </form>
    </div>


    {% if false %}
    <script>
        {% endif %}
    {% capture assign = "unzerPaypalJS" %}
        document.querySelector( '#orderConfirmAgbBottom' ).addEventListener('submit', function( event ) {
            if(!document.querySelector( '#orderConfirmAgbBottom' ).classList.contains("submitable")){
                event.preventDefault();
                document.querySelector( '#payment-saved-cards' ).requestSubmit();
            }
        });

        document.getElementsByName('paymenttypeid').forEach(input => input.addEventListener('change', function(event) {
            event.preventDefault();
            document.getElementsByName('paymenttypeid').forEach(input => { input.checked = false; });
            this.checked = true;
        }));

        document.querySelector('#oscunzersavepayment').addEventListener('change', function(event) {
            event.preventDefault();
            document.getElementsByName('paymenttypeid').forEach(input => { input.checked = false; });
        });

        let unzerInstance = new unzer('{{ unzerpub }}', { locale: "{{ unzerLocale }}" });
        let PayPal = unzerInstance.Paypal();

        // Handling payment form submission
        document.querySelector( "#payment-saved-cards" ).addEventListener('submit', function( event ) {
            event.preventDefault();
            let checkedInput = document.querySelector('input[name=paymenttypeid]:checked');
            if (checkedInput) {
                let selectedPaymentTypeId = checkedInput.value;
                let paymentData = {
                    id: selectedPaymentTypeId,
                    resources: {
                        typeId: selectedPaymentTypeId
                    }
                };
                let paymentDataString = JSON.stringify(paymentData);

                let hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'paymentData';
                hiddenInput.value = paymentDataString;

                let hiddenInput1 = document.createElement('input');
                hiddenInput1.type = 'hidden';
                hiddenInput1.name = 'oscunzersavepayment';
                hiddenInput1.value = document.querySelector('#oscunzersavepayment').checked ? '1' : '0';

                document.querySelector('#orderConfirmAgbBottom').classList.add("submitable");
                document.querySelector('#orderConfirmAgbBottom').append(hiddenInput);
                document.querySelector('#orderConfirmAgbBottom').append(hiddenInput1);
                document.querySelector('#orderConfirmAgbBottom').submit();
            } else {
                PayPal.createResource().then(function(result) {
                    let hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'paymentData';
                    hiddenInput.value = JSON.stringify(result);

                    let hiddenInput1 = document.createElement('input');
                    hiddenInput1.type = 'hidden';
                    hiddenInput1.name = 'oscunzersavepayment';
                    hiddenInput1.value = document.querySelector('#oscunzersavepayment').checked ? '1' : '0';

                    document.querySelector('#orderConfirmAgbBottom').classList.add("submitable");
                    document.querySelector('#orderConfirmAgbBottom').append(hiddenInput);
                    document.querySelector('#orderConfirmAgbBottom').append(hiddenInput1);
                    document.querySelector('#orderConfirmAgbBottom').submit();
                }).catch(function(error) {
                    console.error('error' + error.message);

                    window.scrollTo({
                        top: document.getElementById("orderPayment").offsetTop - 150,
                        behavior: 'smooth'
                    });

                    let errorField = document.getElementById("card-element-id-number");
                    let errorDiv = errorField.querySelector('div');
                    errorDiv.classList.add('error');
                    let errorEl = errorField.querySelector('div.error.message');
                    errorEl.style.display = 'inline-block';
                    errorEl.textContent = error.message;
                    zahlungsButton.disabled = false;
                    document.getElementById('submitOrder').disabled = false;
                });
            }
        });
    {% endcapture %}
    {% if false %}
        </script>
    {% endif %}
    {{ script({ add: unzerPaypalJS, dynamic: __oxid_include_dynamic }) }}
{% endif %}
