{% include "@osc-unzer/frontend/tpl/order/unzer_assets.html.twig" %}
<script type="text/javascript" async
        src="https://h.online-metrix.net/fp/tags.js?org_id=363t8kgq&session_id={{ unzerThreatMetrixSessionID }}">
</script>

{% set invadr = oView.getInvoiceAddress() %}
{% set iBirthdayMonth = 0 %}
{% set iBirthdayDay = 0 %}
{% set iBirthdayYear = 0 %}
{% set isCompany = false %}
{% set isBoth = false %}
{% set isB2B = false %}
{% set isB2C = false %}
{% if isset( invadr.oxuser__oxbirthdate.month ) %}
    {% set iBirthdayMonth = invadr.oxuser__oxbirthdate.month %}
{% elseif oxcmp_user.oxuser__oxbirthdate.value and oxcmp_user.oxuser__oxbirthdate.value != "0000-00-00" %}
    {% set iBirthdayMonth = oxcmp_user.oxuser__oxbirthdate.value|split("-")[1] %}
{% endif %}

{% if isset( invadr.oxuser__oxbirthdate.day ) %}
    {% set iBirthdayDay = invadr.oxuser__oxbirthdate.day %}
{% elseif oxcmp_user.oxuser__oxbirthdate.value and oxcmp_user.oxuser__oxbirthdate.value != "0000-00-00" %}
    {% set iBirthdayDay = oxcmp_user.oxuser__oxbirthdate.value|split("-")[2] %}
{% endif %}

{% if isset( invadr.oxuser__oxbirthdate.year ) %}
    {% set iBirthdayYear = invadr.oxuser__oxbirthdate.year %}
{% elseif oxcmp_user.oxuser__oxbirthdate.value and oxcmp_user.oxuser__oxbirthdate.value != "0000-00-00" %}
    {% set iBirthdayYear = oxcmp_user.oxuser__oxbirthdate.value|split("-")[0] %}
{% endif %}
{% if (oxcmp_user.oxuser__oxcompany.value or (invadr and invadr.oxaddress__oxcompany.value)) %}
    {% set isCompany = true %}
{% endif %}

{% if oViewConf.isB2CInvoiceEligibility() %}
    {% set isB2C = true %}
{% endif %}
{% if oViewConf.isB2BInvoiceEligibility() %}
    {% set isB2B = true %}
{% endif %}
{% if isB2C and (isB2B and isCompany) %}
    {% set isBoth = true %}
{% endif %}
{% if isCompany %}
    {% set customerType = "B2B" %}
{% else %}
    {% set customerType = "B2C" %}
{% endif %}

{% block unzer_inv_secured_birthdate %}
    <form id="payment-form" class="js-oxValidate form-horizontal unzerUI form" novalidate="novalidate">
        {% if false and isBoth %}
            <div class="form-group row unzerConsumer text-danger">
                <div class="col-12 col-lg-9 col-lg-offset-3">
                    <select id="unzer_select_consumer" class="form-control selectpicker" required>
                        <option value="" label="{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET" }) }}" for="unzer_select_consumer">{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET" }) }}</option>
                        <option value="B2B" label="{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2B" }) }}">{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2B" }) }}</option>
                        <option value="B2C" label="{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2C" }) }}">{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2C" }) }}</option>
                    </select>
                </div>
            </div>
        {% else %}
            <input id="unzer_select_consumer" type="hidden" value="{% if isB2B %} {{ 'B2B' }} {% else %} {{ 'B2C' }} {% endif %}" />
        {% endif %}

        <div id="paylater-invoice">
            <!-- ... The Payment form UI element (opt-in text and checkbox) will be inserted here -->
        </div>
        <div id="error-holder" class="field" style="color: #9f3a38">
            <!-- Errors will be inserted here -->
        </div>

        <div id="consumer_common" class="form-group row oxDate {% if not iBirthdayMonth or not iBirthdayDay or not iBirthdayYear %}text-muted{% endif %}">
            <label class="col-12 col-lg-3 req" for="oxDay">{{ translate({ ident: "BIRTHDATE" }) }}</label>
            <div class="col-3 col-lg-3">
                <input id="birthdate_day" class="oxDay form-control" type="text" maxlength="2" value="{% if iBirthdayDay > 0 %}{{ iBirthdayDay }}{% endif %}"
                       placeholder="{{ translate({ ident: "DAY" }) }}" required>
            </div>
            <div class="col-6 col-lg-3">
                <select id="birthdate_month" class="oxMonth form-control selectpicker" required>
                    <option value="" label="-">-</option>
                    {% for month in 1..12 %}
                        <option value="{{ month }}" {% if iBirthdayMonth == month %} selected="selected" {% endif %}>
                            {{ translate({ ident: "MONTH_NAME_"|cat(month) }) }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-3 col-lg-3">
                <input id="birthdate_year" class="oxYear form-control" type="text" maxlength="4" value="{% if iBirthdayYear %}{{ iBirthdayYear }}{% endif %}"
                       placeholder="{{ translate({ ident: "YEAR" }) }}" required>
            </div>
            <div class="offset-lg-3 col-lg-9 col-12">
                <div class="help-block">
                    <p class="text-muted {% if iBirthdayMonth and iBirthdayDay and iBirthdayYear %}d-none hidden{% endif %}">{{ translate({ ident: "OSCUNZER_COMPANY_FORM_birthday" }) }}</p>
                </div>
            </div>
        </div>
        {% if isCompany %}
        <div id="consumer_b2b" class="form-group row unzerCompanyForm text-danger">
            <label class="col-12 col-lg-3  req" for="unzer_company_form">{{ translate({ ident: "OSCUNZER_COMPANY_FORM"}) }}</label>
            <div class="col-12 col-lg-9">
                <select id="unzer_company_form" class="form-control selectpicker" required>
                    <option value="" label="-">-</option>
                    {% for key, companyTypes in oView.getUnzerCompanyTypes() %}
                        <option value="{{ key }}" label="{{ companyTypes }}">{{ companyTypes }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endif %}
    </form>

    {% capture assign = "unzerInvoiceJS" %}
    {% if false %}<script>{% endif %}
        let showB2B = function() {
            document.getElementById('consumer_b2c').style.visibility = "hidden";
            document.getElementById('consumer_b2b').style.visibility = "visible";
        };
        let showB2C = function showB2C() {
            document.getElementById('consumer_b2c').style.visibility = "visible";
            document.getElementById('consumer_b2b').style.visibility = "hidden";
        };
        {% if isBoth %}
            document.querySelector('#unzer_select_consumer').addEventListener('change', function() {
                opt = this.value;
                if (opt === "B2B") {
                    document.getElementById('consumer_b2c').style.visibility = "hidden";
                    document.getElementById('consumer_b2b').style.visibility = "visible";
                }
                else if (opt === "B2C") {
                    document.getElementById('consumer_b2c').style.visibility = "visible";
                    document.getElementById('consumer_b2b').style.visibility = "hidden";
                }
                else {
                    document.getElementById('consumer_b2c').style.visibility = "hidden";
                    document.getElementById('consumer_b2b').style.visibility = "hidden";
                }
            });
        {% endif %}

        {% if isCompany %}
            //showB2B();
            let unzerInstance = new unzer('{{ oViewConf.getUnzerB2BPubKey() }}', {locale: "{{ unzerLocale }}"});
        {% else %}
            //showB2C();
            let unzerInstance = new unzer('{{ oViewConf.getUnzerB2CPubKey() }}', {locale: "{{ unzerLocale }}"});
        {% endif %}
        let paylaterInvoice = unzerInstance.PaylaterInvoice();
        paylaterInvoice.create({
            containerId: 'paylater-invoice',
            customerType: '{{ customerType }}', // B2C or B2B
            errorHolderId: 'error-holder',
        })

        // Handle payment form submission.
        document.querySelector( "#payment-form" ).addEventListener('submit', function( event ) {
            event.preventDefault();
            paylaterInvoice.createResource()
            .then(function(result) {
                let typeId = result.id;
                // submit the payment type ID to your server-side integration
                let selectConsumer = '{{ customerType }}';
                if(
                    (
                        !document.querySelector( '.oxDate' ).classList.contains("text-danger") && selectConsumer === 'B2C'
                    )
                {% if isCompany %}
                    || (
                        !document.querySelector( '.unzerCompanyForm' ).classList.contains("text-danger") && selectConsumer === 'B2B'
                    )
                {% endif %}
                ) {
                {% if isCompany %}
                    let hiddenInputCompanyForm = document.createElement('input');
                    hiddenInputCompanyForm.setAttribute('type', 'hidden');
                    hiddenInputCompanyForm.setAttribute('name', 'unzer_company_form');
                    hiddenInputCompanyForm.value = document.getElementById('unzer_company_form').value;
                    document.querySelector('#orderConfirmAgbBottom').append(hiddenInputCompanyForm);
                {% endif %}
                    let hiddenInputBirthdate = document.createElement('input');
                    hiddenInputBirthdate.setAttribute('type', 'hidden');
                    hiddenInputBirthdate.setAttribute('name', 'birthdate');
                    hiddenInputBirthdate.value = document.querySelector('#birthdate_year').value + '-' +
                                                 document.querySelector('#birthdate_month').value + '-' +
                                                 document.querySelector('#birthdate_day').value;
                    document.querySelector('#orderConfirmAgbBottom').append(hiddenInputBirthdate);

                    let hiddenCustomerType = document.createElement('input');
                    hiddenCustomerType.setAttribute('type', 'hidden');
                    hiddenCustomerType.setAttribute('name', 'unzer_customer_type');
                    hiddenCustomerType.value = '{{ customerType }}';
                    document.querySelector('#orderConfirmAgbBottom').append(hiddenCustomerType);

                    let hiddenTypeId = document.createElement('input');
                    hiddenTypeId.setAttribute('type', 'hidden');
                    hiddenTypeId.setAttribute('name', 'unzer_type_id');
                    hiddenTypeId.value = typeId;
                    document.querySelector('#orderConfirmAgbBottom').append(hiddenTypeId);

                    document.querySelector('#orderConfirmAgbBottom' ).classList.add("submitable");
                    document.querySelector("#orderConfirmAgbBottom" ).submit();
                } else {
                    document.querySelector('html, body').animate({
                        scrollTop: document.querySelector("#orderPayment").getBoundingClientRect().top + window.scrollY - 150
                    }, 350);
                }
            })
            .catch(function(error) {
                document.getElementById('error-holder').innerText = error.customerMessage || error.message || 'Error'
            })

        });

        document.querySelector('#orderConfirmAgbBottom').addEventListener('submit', function( event ) {
            if(!document.querySelector('#orderConfirmAgbBottom').classList.contains("submitable")){
                event.preventDefault();
                document.querySelector("#payment-form").requestSubmit();
            }
        });

        {% if isCompany %}
            document.querySelector( '#unzer_company_form' ).addEventListener('change', function(event) {
                event.preventDefault();
                if (document.querySelector('#unzer_company_form').value === "") {
                    document.querySelector( '.unzerCompanyForm' ).classList.add("text-danger");
                } else {
                    document.querySelector( '.unzerCompanyForm' ).classList.remove("text-danger");
                }
            });
        {% endif %}

        document.querySelector( '#birthdate_year' ).addEventListener('change', function(event) {
            event.preventDefault();
            if (document.querySelector('#birthdate_year').value === "") {
                document.querySelector( '.oxDate' ).classList.add("text-danger");
            } else {
                document.querySelector( '.oxDate' ).classList.remove("text-danger");
            }
        });

        document.querySelector( '#birthdate_month' ).addEventListener('change', function(event) {
            event.preventDefault();
            if (document.querySelector('#birthdate_month').value === "") {
                document.querySelector( '.oxDate' ).classList.add("text-danger");
            } else {
                document.querySelector( '.oxDate' ).classList.remove("text-danger");
            }
        });

        document.querySelector( '#birthdate_day' ).addEventListener('change', function(event) {
            event.preventDefault();
            if (document.querySelector('#birthdate_day').value === "") {
                document.querySelector( '.oxDate' ).classList.add("text-danger");
            } else {
                document.querySelector( '.oxDate' ).classList.remove("text-danger");
            }
        });

         document.querySelectorAll("#payment-form input").forEach(function(element) {
            element.addEventListener("input", function() {
                document.querySelector('#error-holder').innerHTML = '';
                document.querySelector("#submitOrder").classList.add("submitable");
                document.querySelector("#submitOrder").disabled = false;
            });
        });
    {% if false %}</script>{% endif %}
    {% endcapture %}
    {{ script({ add: unzerInvoiceJS, dynamic: __oxid_include_dynamic }) }}
{% endblock %}
