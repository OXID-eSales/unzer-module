{% include "@osc-unzer/frontend/tpl/order/unzer_assets.html.twig" %}

{% set invadr = oView.getInvoiceAddress() %}
{% set deladr = oView.getDelAddress() %}
{% set iBirthdayMonth = 0 %}
{% set iBirthdayDay = 0 %}
{% set iBirthdayYear = 0 %}
{% set isCompany = false %}
{% set isBoth = false %}
{% set isB2B = false %}
{% set isB2C = false %}
{% if isset( invadr.oxuser__oxbirthdate.month ) %}
    {% set iBirthdayMonth = invadr.oxuser__oxbirthdate.month %}
{% elseif oxcmp_user.oxuser__oxbirthdate.value and oxcmp_user.oxuser__oxbirthdate.value != "0000-00 - 00" %}
    {% set iBirthdayMonth = oxcmp_user.oxuser__oxbirthdate.value|regex_replace("/^([0-9]{4)})[-]/":""|regex_replace("/[-]([0-9]{1,) 2})$/":"" %}
{% endif %}

{% if isset( invadr.oxuser__oxbirthdate.day ) %}
    {% set iBirthdayDay = invadr.oxuser__oxbirthdate.day %}
{% elseif oxcmp_user.oxuser__oxbirthdate.value and oxcmp_user.oxuser__oxbirthdate.value != "0000-00 - 00" %}
    {% set iBirthdayDay = oxcmp_user.oxuser__oxbirthdate.value|regex_replace("/^([0-9]{4)})[-]([0-9]{1, 2})[-]/":"" %}
{% endif %}

{% if isset( invadr.oxuser__oxbirthdate.year ) %}
    {% set iBirthdayYear = invadr.oxuser__oxbirthdate.year %}
{% elseif oxcmp_user.oxuser__oxbirthdate.value and oxcmp_user.oxuser__oxbirthdate.value != "0000-00 - 00" %}
    {% set iBirthdayYear = oxcmp_user.oxuser__oxbirthdate.value|regex_replace("/[-]([0-9]{1,) 2})[-]([0-9]{1, 2})$/":"" %}
{% endif %}
{% if (oxcmp_user.oxuser__oxcompany.value or (deladr and deladr.oxaddress__oxcompany.value)) %}
    {% set isCompany = true %}
{% endif %}

{% if oViewConf.isB2CInvoiceEligibility() %}
    {% set isB2C = true %}
    {% endif %}
{% if oViewConf.isB2BInvoiceEligibility() %}
    {% set isB2B = true %}
    {% endif %}
{% if isB2C and (isB2B and isCompany) %}
    {% set isBoth = true %}
{% endif %}

{% block unzer_inv_secured_birthdate %}
    <form id="payment-form-invoice" class="js-oxValidate form-horizontal" novalidate="novalidate">
        {% if isBoth %}
            <div class="form-group row unzerConsumer text-danger">
                <div class="col-12 col-lg-9 col-lg-offset-3">
                    <select id="unzer_select_consumer" class="form-control selectpicker" required>
                        <option value="" label="{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET" }) }}" for="unzer_select_consumer">{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET" }) }}</option>
                        <option value="B2B" label="{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2B" }) }}">{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2B" }) }}</option>
                        <option value="B2C" label="{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2C" }) }}">{{ translate({ ident: "OSCUNZER_CONSUMER_TARGET_B2C" }) }}</option>
                    </select>
                </div>
            </div>
        {% endif %}
        {% if isB2B and isCompany %}
            <div id="consumer_b2b" {% if isBoth %}class="collapse"{% endif %}>
                <div id="consumer_b2b" class="form-group row unzerCommercialSector text-danger">
                    <label class="col-12 col-lg-3  req" for="unzer_commercial_sector">{{ translate({ ident: "OSCUNZER_COMMERCIAL_SECTOR" }) }}</label>
                    <div class="col-12 col-lg-9">
                        <select id="unzer_commercial_sector" class="form-control selectpicker" required>
                            <option value="" label="-">-</option>
                            {% for value, title in oView.getUnzerCommercialSectors() %}
                                <option value="{{ value }}" label="{{ title }}">{{ title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group row text-danger">
                    <label class="col-12 col-lg-3 req" for="unzer_commercial_register_number">{{ translate({ ident: "OSCUNZER_COMMERCIAL_REGISTER_NUMBER" }) }}</label>
                    <div class="col-12 col-lg-9">
                        <input id="unzer_commercial_register_number" class="form-control" type="text" maxlength="20" value=""
                               placeholder="{{ translate({ ident: "OSCUNZER_COMMERCIAL_REGISTER_NUMBER" }) }}" required>
                    </div>
                    <div class="offset-lg-3 col-lg-9 col-12">
                        <div class="help-block">
                            <p class="text-danger">{{ translate({ ident: "OSCUNZER_COMMERCIAL_HELP" }) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if isB2C %}
            <div id="consumer_b2c" class="form-group row oxDate {% if not iBirthdayMonth or not iBirthdayDay or not iBirthdayYear %}text-danger{% endif %} {% if isBoth %}collapse{% endif %}">
                <label class="col-12 col-lg-3 req" for="oxDay">{{ translate({ ident: "BIRTHDATE" }) }}</label>
                <div class="col-3 col-lg-3">
                    <input id="birthdate_day" class="oxDay form-control" type="text" maxlength="2" value="{% if iBirthdayDay > 0 %}{{ iBirthdayDay }}{% endif %}"
                           placeholder="{{ translate({ ident: "DAY" }) }}" required>
                </div>
                <div class="col-6 col-lg-3">
                    <select id="birthdate_month" class="oxMonth form-control selectpicker" required>
                        <option value="" label="-">-</option>
                        {% for month in 1..13 %}
                        <option value="[{loop.index0 %} selected="selected" {% endif %}>
                            {{ translate({ ident: "MONTH_NAME_"|cat(smarty.section.month.index) }) }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-3 col-lg-3">
                    <input id="birthdate_year" class="oxYear form-control" type="text" maxlength="4" value="{% if iBirthdayYear %}{{ iBirthdayYear }}{% endif %}"
                           placeholder="{{ translate({ ident: "YEAR" }) }}" required>
                </div>
                <div class="offset-lg-3 col-lg-9 col-12">
                    <div class="help-block">
                        <p class="text-danger {% if iBirthdayMonth and iBirthdayDay and iBirthdayYear %}d-none hidden{% endif %}">{{ translate({ ident: "DD_FORM_VALIDATION_REQUIRED" }) }}</p>
                    </div>
                </div>
            </div>
        {% endif %}
    </form>
    {% capture assign = "unzerInvoiceJS" %}
    {% if isBoth %}
        $('#unzer_select_consumer').change(function() {
            opt = $(this).val();
            if (opt=="B2B") {
                $('#consumer_b2c').collapse('hide');
                $('#consumer_b2b').collapse('show');
            }
            else if (opt == "B2C") {
                $('#consumer_b2c').collapse('show');
                $('#consumer_b2b').collapse('hide');
            }
            else {
                $('#consumer_b2c').collapse('hide');
                $('#consumer_b2b').collapse('hide');
            }
        });
    {% endif %}

    // Handle payment form submission.
    $( "#payment-form-invoice" ).submit(function( event ) {
        event.preventDefault();
        setTimeout(function(){
            if(
                (
                    !$( '.oxDate' ).hasClass("text-danger") && selectConsumer == 'B2C'
                )
                {% if isCompany %}
                || (
                    !$( '.unzerCommercialSector' ).hasClass("text-danger") && selectConsumer == 'B2B'
                )
                {% endif %}
            ){
                {% if isCompany %}
                    let hiddenInputCommercialSector = $(document.createElement('input'))
                    .attr('type', 'hidden')
                    .attr('name', 'unzer_commercial_sector')
                    .val($('#unzer_commercial_sector').val());
                    $('#orderConfirmAgbBottom').find(".hidden").append(hiddenInputCommercialSector);

                    let hiddenInputRegistrationNumber = $(document.createElement('input'))
                    .attr('type', 'hidden')
                    .attr('name', 'unzer_commercial_register_number')
                    .val($('#unzer_commercial_register_number').val());
                    $('#orderConfirmAgbBottom').find(".hidden").append(hiddenInputRegistrationNumber);
                {% endif %}
                let hiddenInputBirthdate = $(document.createElement('input'))
                .attr('type', 'hidden')
                .attr('name', 'birthdate')
                .val($('#birthdate_year').val()+'-'+$('#birthdate_month').val()+'-'+$('#birthdate_day').val());
                $('#orderConfirmAgbBottom').find(".hidden").append(hiddenInputBirthdate);

                $('#orderConfirmAgbBottom' ).addClass("submitable");
                $("#orderConfirmAgbBottom" ).submit();
            } else {
                $('html, body').animate({
                    scrollTop: $("#orderPayment").offset().top - 150
                }, 350);
            }
        }, 100);
    });

    $('#orderConfirmAgbBottom').submit(function( event ) {
        if(!$('#orderConfirmAgbBottom').hasClass("submitable")){
            event.preventDefault();
            $("#payment-form-invoice").submit();
        }
    });

    {% endcapture %}
    {{ script({ add: unzerInvoiceJS, dynamic: __oxid_include_dynamic }) }}
{% endblock %}
